#!/bin/bash

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}

export RUSTUP_HOME="$CACHE_DIR/rustup"
export CARGO_HOME="$CACHE_DIR/cargo"

mkdir -p "$CACHE_DIR"
cd "$CACHE_DIR"

if [ -d "$CARGO_HOME" ]; then
    echo "-----> Check for up-to-date Rust installation"
    rustup self update
    rustup update stable
else
    echo "-----> Installing Rust"
    curl https://sh.rustup.rs -sSf > rustup.sh
    chmod u+x rustup.sh
    echo "RUSTUP_HOME: $RUSTUP_HOME"
    echo "CARGO_HOME: $CARGO_HOME"
    ./rustup.sh -y --default-toolchain stable
    rm rustup.sh
fi

source "$CARGO_HOME/env"

echo "-----> Installing MZoon"
cargo install mzoon --git https://github.com/MoonZoon/MoonZoon --rev $(<mzoon_commit) --root "$CACHE_DIR/mzoon_install_root" --locked

MZOON = "$CACHE_DIR/mzoon_install_root/bin/mzoon"
if [ ! -x "$MZOON" ]; then
  echo "Installing mzoon failed"
  exit 1
fi


cd $BUILD_DIR

echo "-----> Building app"
mzoon_install_root/bin/mzoon build -r
